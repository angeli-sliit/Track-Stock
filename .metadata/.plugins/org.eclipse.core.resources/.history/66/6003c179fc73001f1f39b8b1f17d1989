<%@ include file="../Dashboard/headeradmin.jsp" %>
<%@ page import="java.sql.Connection, java.sql.PreparedStatement, java.sql.ResultSet, java.sql.SQLException" %>
<%@ page import="auth.DbConn" %>

<%
    HttpServletRequest httpRequest = (HttpServletRequest) pageContext.getRequest();
    String contextPath = httpRequest.getContextPath();
    
    // Fetch users from the database
    Connection conn = null;
    PreparedStatement ps = null;
    ResultSet rs = null;

    String query = "SELECT User_ID, name, username, user_role, status, last_login FROM registered_user";
    
    try {
        conn = DbConn.getConnection();
        ps = conn.prepareStatement(query);
        rs = ps.executeQuery();
    } catch (SQLException e) {
        e.printStackTrace();
    }
%>

<title>Track-Stock - UserDetails</title>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
</head>
<body>
<div class="page">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12"></div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="panel panel-default">
          <div class="panel-heading clearfix">
            <strong>
              <span class="glyphicon glyphicon-th"></span>
              <span>Users</span>
            </strong>
            <a href="add_user.php" class="btn btn-info pull-right">Add New User</a>
          </div>
          <div class="panel-body">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th class="text-center" style="width: 50px;">#</th>
                  <th>Name</th>
                  <th>Username</th>
                  <th class="text-center" style="width: 15%;">User Role</th>
                  <th class="text-center" style="width: 10%;">Status</th>
                  <th style="width: 20%;">Last Login</th>
                  <th class="text-center" style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <%
                  int count = 1;
                  while (rs != null && rs.next()) {
                    String userId = rs.getString("User_ID");
                    String name = rs.getString("name");
                    String username = rs.getString("username");
                    String userRole = rs.getString("user_role");
                    String status = rs.getString("status");
                    String lastLogin = rs.getString("last_login") != null ? rs.getString("last_login") : "No login history";

                    out.println("<tr>");
                    out.println("<td class='text-center'>" + count + "</td>");
                    out.println("<td>" + name + "</td>");
                    out.println("<td>" + username + "</td>");
                    out.println("<td class='text-center'>" + userRole + "</td>");
                    out.println("<td class='text-center'><span class='label label-success'>" + status + "</span></td>");
                    out.println("<td>" + lastLogin + "</td>");
                    out.println("<td class='text-center'><div class='btn-group'>");
                    out.println("<a href='edit_user.php?id=" + userId + "' class='btn btn-xs btn-warning'><i class='glyphicon glyphicon-pencil'></i></a>");
                    out.println("<a href='delete_user.php?id=" + userId + "' class='btn btn-xs btn-danger'><i class='glyphicon glyphicon-remove'></i></a>");
                    out.println("</div></td>");
                    out.println("</tr>");
                    count++;
                  }
                %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>

<%
    // Close database resources
    if (rs != null) rs.close();
    if (ps != null) ps.close();
    if (conn != null) conn.close();
%>
